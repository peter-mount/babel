# docker image containing babel & eslint

A docker image to aid in compiling nodejs applications using babel.

The reason for this is that babel is itself pretty large so this image reduces the number of times that babel has to be downloaded from the npm repository.

## Including in a build

In this example we have the local repository laid out as:
    Dockerfile
    package.json
    src/index.js

The docker file will then install the application into /opt/node with packages in /opt/node/node_modules and src/index.js compiled as /opt/node/index.js

    # The default architecture
    ARG arch=amd64

    FROM area51/${arch}-babel:latest as builder

    # The application's final location
    WORKDIR /opt/node

    # Install our dependencies
    ADD $module/package.json .
    RUN npm install

    # Now compile the module
    ADD src /tmp/src/
    RUN eslint /tmp/src
    RUN babel /tmp/src

    # Now build the final image
    FROM area51/${arch}-node:latest
    LABEL maintainer="Peter Mount <peter@retep.org>"

    WORKDIR /opt/node

    COPY --from=builder /opt/node /opt/node/

    CMD ["node","index.js"]

## How this works

This Dockerfile is a multi stage build. Stage 1 does the compilation whilst stage 2 creates the final image.

### Multi-architectures

The ARG arch=amd64 line defines the default architecture for the build, so if you run:

    docker build -t mytag .

Then it will build on amd64.

If you are running on a different architecture then you can select this on the build line. e.g.

    docker build -t mytag --build-arg arch=amd64 .

The supported architectures are:
* amd64
* arm64v8
* arm32v6 when I fix that build server

### Stage 1 - compilation

Here we use this image as the underlying image and label it as builder.

We then set the WORKDIR to where we want the application to be install to within the container.

Next we add package.json and run npm install to install the applications dependencies.

After that we copy the src directory into /tmp/src in the image.

Note: We do this after running npm install so that if the source changes but not package.json we utilises docker's cache and don't install the dependencies every time - another time saver.

Next we run eslint against /tmp/src. This is optional but allows for errors to be found before compilation.

Finally we run babel against /tmp/src. This will compile those .js files and place them unto the currect WORKDIR.

### Stage 2 - building the final image

Here we use the final page image, here our own node image. We set WORKDIR to the same location then copy that directory from stage 1.

Finally we add the command to start the application.

## Command reference

### babel

    babel source [destination]

This will compile all .js files under source and place the result in the destination.

If destination is not provided then the current directory is used.

### eslint

    eslint source

Runs eslint against the source, checking for errors or warnings. Any errors will fail the build.

### usenpmrepository

    usenpmrepository [url]

This will point npm to use an alternate third-pary npm repository rather than the default public one. If no url is provided then the public one is used.

## Running eslint --fix

This is trickier but doable. It will modify your source for most warnings generated by eslint.

*Perform a backup of your source first!*

If you have your source in the src directory, run the following from the parent directory:

    docker run -it --rm -v $(pwd)/src:/usr/local/babel/src area51/amd64-babel eslintfix

This will then run eslint --fix against your source.

NB: Change amd64 to the correct architecture you are using.

## Useful files

* /usr/local/babel/.babelrc
* /usr/local/babel/.eslintrc

If you need to override any of those config files then overwrite them in the Dockerfile before running babel or eslint.

If overriding .eslintrc when using eslintfix you need to mount it on the command line:

    docker run -it --rm \
      -v $(pwd)/.eslintrc:/usr/local/babel/.eslintrc:ro \
      -v $(pwd)/src:/usr/local/babel/src area51/amd64-babel \
      eslintfix
